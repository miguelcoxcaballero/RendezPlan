<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RendezPlan - Disponibilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librer√≠as para la generaci√≥n de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --accent-green: #16a34a; 
            --accent-green-dark: #14532d; 
            --border-light: #f1f5f9;
            --border-hour: #cbd5e1;
            --text-main: #1f2937;
            --text-muted: #64748b;
            --night-bg: #e2e8f0; 
            --today-highlight: #f0fdf4;
            --today-highlight-night: #cbd5e1; 
            --noon-color: #fbbf24; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; 
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            -webkit-user-select: none;
            user-select: none;
        }

        header {
            width: 96%;
            max-width: 1400px;
            margin: 1rem auto 0.5rem auto;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .app-card {
            width: 96%;
            max-width: 1400px;
            margin: 0 auto 1.5rem auto;
            flex: 1;
            background-color: #ffffff;
            border-radius: 1.5rem; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
        }

        /* VISTA SEMANA */
        .grid-wrapper {
            flex: 1;
            display: grid;
            grid-template-columns: 65px repeat(7, 1fr);
            grid-template-rows: 45px repeat(14, 0.8fr) repeat(30, 1.3fr) repeat(4, 0.8fr);
            overflow: hidden;
            background-color: #fff;
            position: relative;
        }

        /* VISTA MES */
        .month-wrapper {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: 40px repeat(6, 1fr);
            gap: 8px; 
            padding: 8px; 
            overflow: hidden;
            background-color: #f8fafc; 
        }

        .header-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e2e8f0;
            border-bottom: 2px solid #94a3b8;
            background-color: #fff;
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            z-index: 10;
        }

        .month-wrapper .header-cell {
            background-color: transparent;
            border: none;
        }

        .header-cell.is-today {
            background-color: var(--today-highlight);
            color: var(--accent-green);
        }

        .header-cell b { font-size: 0.9rem; margin-top: -2px; }

        .time-label {
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 0.65rem;
            font-weight: 500;
            color: var(--text-muted);
            border-right: 1px solid #e2e8f0;
            line-height: 1;
            position: relative;
            overflow: visible;
            min-height: 0;
            background-color: #fafafa;
            z-index: 60;
        }

        .time-text {
            display: inline-block;
            transform: translateY(-50%);
            padding: 0 2px;
            z-index: 61;
            background-color: #fafafa;
            position: relative;
        }

        .cell {
            border-right: 1px solid var(--border-light);
            border-bottom: 1px solid var(--border-light);
            cursor: crosshair;
            transition: background-color 0.05s;
            touch-action: none;
            min-height: 0;
        }

        .cell.night-slot { background-color: var(--night-bg); }
        .cell.night-slot.is-today { background-color: var(--today-highlight-night); }
        .cell.hour-mark { border-top: 1px solid var(--border-hour) !important; }

        .cell.selected {
            background-color: var(--accent-green) !important;
            border-color: rgba(0,0,0,0.05);
        }
        .cell.night-slot.selected {
            background-color: var(--accent-green-dark) !important;
        }

        .noon-line-indicator {
            position: absolute;
            left: 0;
            right: 0;
            height: 3px;
            background-color: var(--noon-color);
            pointer-events: none;
            z-index: 50;
        }

        .month-day {
            border: 1px solid var(--border-light);
            border-radius: 1rem; 
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        .month-day.other-month { opacity: 0.4; background-color: #fdfdfd; }
        
        .month-day .day-num-wrapper {
            position: absolute;
            top: 6px;
            left: 6px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            pointer-events: none;
        }
        
        .month-day .day-num { font-weight: 700; font-size: 0.7rem; color: var(--text-muted); }
        .month-day.is-today .day-num-wrapper { background-color: var(--accent-green); }
        .month-day.is-today .day-num { color: white; }

        .mini-schedule-container {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            width: 100%;
            padding: 0;
            pointer-events: none;
        }
        .mini-slot { flex: 1; width: 100%; }
        .mini-slot.active { background-color: var(--accent-green); opacity: 0.8; }
        .mini-slot.active.night-slot { background-color: var(--accent-green-dark); }
        .mini-slot.inactive.night-slot { background-color: rgba(0,0,0,0.05); }

        .mini-noon-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--noon-color);
            z-index: 4;
        }

        .footer-nav {
            height: 55px;
            border-top: 2px solid var(--border-hour);
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            flex-shrink: 0;
        }

        .nav-controls { display: flex; align-items: center; gap: 0.5rem; }
        .current-label { font-weight: 700; font-size: 0.85rem; color: var(--text-main); min-width: 160px; text-align: center; }

        .noon-selector-wrapper {
            display: flex;
            align-items: center; gap: 0.5rem;
            background-color: #f8fafc;
            padding: 0.3rem 0.75rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }
        .noon-selector-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        .noon-input {
            background: transparent;
            font-size: 0.75rem;
            font-weight: 800;
            color: var(--noon-color);
            width: 50px;
            text-align: center;
            border: none;
            outline: none;
        }

        .view-selector {
            display: flex;
            background-color: #f1f5f9;
            padding: 3px;
            border-radius: 0.75rem;
        }
        .view-btn {
            padding: 0.4rem 1rem;
            border-radius: 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .view-btn.active {
            background-color: white;
            color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .btn-action, .btn-icon-action {
            height: 42px; 
            padding: 0 1.25rem;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon-action { width: 42px; padding: 0; font-size: 1.1rem; }

        .btn-primary { background-color: var(--accent-green); color: white; }
        .btn-primary:hover { background-color: #15803d; transform: translateY(-1px); }
        .btn-secondary { color: var(--text-muted); border: 1px solid #e2e8f0; background-color: white; }

        #toast {
            position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 0.75rem 1.5rem; border-radius: 1rem;
            font-size: 0.9rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
            z-index: 100; display: flex; align-items: center; gap: 0.75rem;
            opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none;
        }
        #toast.visible { opacity: 1; transform: translateX(-50%) translateY(-20px); }

        .tz-capsule {
            background-color: #f1f5f9;
            padding: 4px 10px;
            border-radius: 99px;
            font-size: 9px;
            font-weight: 800;
            color: var(--text-muted);
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        /* Modales */
        #tz-modal, #confirm-modal {
            display: none;
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .modal-small { max-width: 400px; text-align: center; }
        
        .tz-step-container { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .tz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; }
        
        .tz-button {
            padding: 0.75rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .tz-button .city { font-size: 0.7rem; color: var(--text-muted); font-weight: 400; }
        .tz-button:hover { background-color: #f1f5f9; border-color: var(--accent-green); color: var(--accent-green); }

        /* Estilos PDF - √Årea Oculta */
        #pdf-render-area {
            position: fixed;
            left: -5000px; 
            top: 0;
            width: 800px; 
            background-color: white;
            z-index: -100;
            pointer-events: none;
        }

        .pdf-page-wrapper {
            padding: 40px;
            background: white;
            width: 794px; /* A4 width */
            min-height: 1123px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        .pdf-header-box {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 10px;
        }

        .pdf-main-title { font-size: 24px; font-weight: 800; color: #111; }
        .pdf-period-tag { font-size: 14px; color: #64748b; font-weight: 600; }
    </style>
</head>
<body>

    <header>
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-green-600 rounded-xl flex items-center justify-center text-white shadow-md">
                <i class="fa-solid fa-bolt-lightning text-lg"></i>
            </div>
            <h1 class="text-xl font-extrabold tracking-tight text-slate-900 leading-none">RendezPlan</h1>
        </div>

        <div class="flex items-center gap-3">
            <button onclick="openConfirmModal()" class="btn-action btn-secondary shadow-sm">
                <i class="fa-solid fa-eraser mr-2"></i>
                <span id="reset-btn-label">Limpiar...</span>
            </button>

            <div id="copy-paste-group" class="flex gap-2">
                <button id="pdf-btn" onclick="exportToPDF()" class="btn-icon-action btn-secondary shadow-sm" title="Exportar horario a PDF">
                    <i class="fa-solid fa-file-pdf text-red-500"></i>
                </button>
                <button onclick="copyWeekToClipboard()" class="btn-icon-action btn-primary shadow-md" title="Copiar horario semanal">
                    <i class="fa-solid fa-copy"></i>
                </button>
                <button id="paste-btn" onclick="pasteFromClipboard()" class="btn-icon-action btn-secondary shadow-sm opacity-50 cursor-not-allowed" title="Pegar horario semanal" disabled>
                    <i class="fa-solid fa-paste"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="app-card">
        <main id="main-view-container" class="flex-1 overflow-hidden flex flex-col">
            <!-- Grid Din√°mico -->
        </main>

        <footer class="footer-nav">
            <div class="nav-controls">
                <button onclick="changePeriod(-1)" class="btn-icon"><i class="fa-solid fa-chevron-left"></i></button>
                <span id="current-period-label" class="current-label">Cargando...</span>
                <button onclick="changePeriod(1)" class="btn-icon"><i class="fa-solid fa-chevron-right"></i></button>
            </div>

            <div class="noon-selector-wrapper">
                <span class="noon-selector-label"><i class="fa-solid fa-sun mr-1"></i>Mediod√≠a:</span>
                <input type="text" id="noon-input" class="noon-input" placeholder="14:00" maxlength="5" oninput="validateAndUpdateNoon(this)">
            </div>

            <div class="view-selector">
                <button id="view-week-btn" onclick="setView('week')" class="view-btn active">Semana</button>
                <button id="view-month-btn" onclick="setView('month')" class="view-btn">Mes</button>
            </div>
        </footer>
    </div>

    <div id="pdf-render-area"></div>

    <!-- Modales -->
    <div id="tz-modal" onclick="toggleTZModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-2">
                <h2 id="tz-modal-title" class="text-xl font-bold">Seleccionar Continente</h2>
                <button onclick="toggleTZModal()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div id="tz-step-continents" class="tz-step-container">
                <div class="tz-grid">
                    <button class="tz-button" onclick="showTZList('√Åfrica')">√Åfrica</button>
                    <button class="tz-button" onclick="showTZList('Am√©rica')">Am√©rica</button>
                    <button class="tz-button" onclick="showTZList('Asia')">Asia</button>
                    <button class="tz-button" onclick="showTZList('Europa')">Europa</button>
                    <button class="tz-button" onclick="showTZList('Ocean√≠a')">Ocean√≠a</button>
                    <button class="tz-button" onclick="showTZList('Ant√°rtida')">Ant√°rtida</button>
                </div>
            </div>
            <div id="tz-step-zones" class="tz-step-container hidden">
                <button onclick="backToContinents()" class="text-xs font-bold text-slate-400 hover:text-slate-600 mb-2 flex items-center gap-1">
                    <i class="fa-solid fa-arrow-left"></i> Volver a Continentes
                </button>
                <div id="tz-zone-grid" class="tz-grid"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button onclick="toggleTZModal()" class="px-6 py-2 bg-gray-100 rounded-xl font-bold text-sm">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" onclick="closeConfirmModal()">
        <div class="modal-content modal-small" onclick="event.stopPropagation()">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fa-solid fa-trash-can text-2xl"></i>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">¬øBorrar disponibilidad?</h2>
            <p id="confirm-modal-text" class="text-slate-500 text-sm leading-relaxed mb-8"></p>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeConfirmModal()" class="btn-action btn-secondary w-full">Cancelar</button>
                <button onclick="executeClear()" class="btn-action bg-red-500 hover:bg-red-600 text-white w-full font-bold">Borrar</button>
            </div>
        </div>
    </div>

    <div id="toast">
        <div id="toast-icon-box" class="bg-green-500 rounded-full w-5 h-5 flex items-center justify-center">
            <i class="fa-solid fa-check text-white text-[10px]"></i>
        </div>
        <span id="toast-text">Copiado</span>
    </div>

    <script>
        const dayNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        const gridElement = document.getElementById('main-view-container');
        const periodLabel = document.getElementById('current-period-label');
        const noonInput = document.getElementById('noon-input');
        const resetBtnLabel = document.getElementById('reset-btn-label');
        const pasteBtn = document.getElementById('paste-btn');
        
        let viewMode = 'week';
        let currentDate = new Date(); 
        let noonTime = "14:00"; 
        let currentTZ = 1; 
        const selectedSlots = new Set(); 
        let weekPatternClipboard = null; 
        let isMouseDown = false;
        let isSelecting = true;

        const tzData = {
            '√Åfrica': [{ offset: -1, city: 'Cabo Verde' }, { offset: 0, city: 'Casablanca' }, { offset: 1, city: 'Lagos' }, { offset: 2, city: 'El Cairo' }, { offset: 3, city: 'Nairobi' }, { offset: 4, city: 'Port Louis' }],
            'Am√©rica': [{ offset: -10, city: 'Honolulu' }, { offset: -9, city: 'Anchorage' }, { offset: -8, city: 'Los √Ångeles' }, { offset: -7, city: 'Denver' }, { offset: -6, city: 'Ciudad de M√©xico' }, { offset: -5, city: 'Nueva York' }, { offset: -4, city: 'Caracas' }, { offset: -3, city: 'Buenos Aires' }, { offset: -2, city: 'Noronha' }],
            'Asia': [{ offset: 3, city: 'Mosc√∫' }, { offset: 4, city: 'Dub√°i' }, { offset: 5, city: 'Taskent' }, { offset: 5.5, city: 'Mumbai' }, { offset: 6, city: 'Dhaka' }, { offset: 7, city: 'Bangkok' }, { offset: 8, city: 'Singapur' }, { offset: 9, city: 'Tokio' }, { offset: 10, city: 'Vladivostok' }, { offset: 12, city: 'Anadyr' }],
            'Europa': [{ offset: 0, city: 'Londres' }, { offset: 1, city: 'Madrid' }, { offset: 2, city: 'Atenas' }, { offset: 3, city: 'Estambul' }],
            'Ocean√≠a': [{ offset: 8, city: 'Perth' }, { offset: 9.5, city: 'Adelaida' }, { offset: 10, city: 'S√≠dney' }, { offset: 11, city: 'Numea' }, { offset: 12, city: 'Auckland' }, { offset: 13, city: 'Fiyi' }],
            'Ant√°rtida': [{ offset: 0, city: 'Base Troll' }, { offset: 6, city: 'Base Vostok' }, { offset: 12, city: 'McMurdo' }]
        };

        function formatISODate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function isToday(date) {
            const today = new Date();
            return formatISODate(date) === formatISODate(today);
        }

        function toggleTZModal() {
            const m = document.getElementById('tz-modal');
            const isVisible = m.style.display === 'flex';
            if (!isVisible) backToContinents();
            m.style.display = isVisible ? 'none' : 'flex';
        }

        function showTZList(continent) {
            document.getElementById('tz-modal-title').innerText = `Referencia: ${continent}`;
            document.getElementById('tz-step-continents').classList.add('hidden');
            document.getElementById('tz-step-zones').classList.remove('hidden');
            const grid = document.getElementById('tz-zone-grid');
            grid.innerHTML = '';
            const zones = tzData[continent] || [];
            zones.forEach(z => {
                const btn = document.createElement('button');
                btn.className = 'tz-button';
                const h = Math.floor(z.offset);
                const m = (z.offset % 1) * 60;
                const label = `UTC${z.offset >= 0 ? '+' : ''}${h}${m ? ':30' : ''}`;
                btn.innerHTML = `<span>${label}</span><span class="city">${z.city}</span>`;
                btn.onclick = () => { currentTZ = z.offset; render(); toggleTZModal(); showToast(`Zona: ${label}`); };
                grid.appendChild(btn);
            });
        }

        function backToContinents() {
            document.getElementById('tz-modal-title').innerText = 'Seleccionar Continente';
            document.getElementById('tz-step-continents').classList.remove('hidden');
            document.getElementById('tz-step-zones').classList.add('hidden');
        }

        function openConfirmModal() {
            const scope = viewMode === 'week' ? 'esta semana' : 'todo este mes';
            document.getElementById('confirm-modal-text').innerText = `¬øSeguro que quieres borrar toda tu disponibilidad registrada para ${scope}? Esta acci√≥n no se puede deshacer.`;
            document.getElementById('confirm-modal').style.display = 'flex';
        }
        function closeConfirmModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        function executeClear() {
            if (viewMode === 'week') {
                const monday = getMonday(currentDate);
                for (let i = 0; i < 7; i++) {
                    const d = new Date(monday); d.setDate(monday.getDate() + i);
                    const iso = formatISODate(d);
                    Array.from(selectedSlots).forEach(id => { if (id.includes(iso)) selectedSlots.delete(id); });
                }
            } else {
                const monthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                Array.from(selectedSlots).forEach(id => { if (id.includes(monthStr)) selectedSlots.delete(id); });
            }
            render(); closeConfirmModal(); showToast("Horario limpiado");
        }

        function validateAndUpdateNoon(input) {
            let val = input.value.trim();
            if (/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(val)) { noonTime = val; render(); }
        }

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function render() {
            gridElement.innerHTML = '';
            resetBtnLabel.innerHTML = viewMode === 'week' ? 'Limpiar <b>Semana</b>' : 'Limpiar <b>MES</b>';
            noonInput.value = noonTime;
            if (viewMode === 'week') renderWeekView(); else renderMonthView();
        }

        function renderWeekView() {
            gridElement.className = 'grid-wrapper';
            const monday = getMonday(currentDate);
            const weekDates = Array.from({length:7}, (_, i) => {
                const d = new Date(monday); d.setDate(monday.getDate() + i); return d;
            });
            periodLabel.innerText = `${monday.toLocaleDateString('es-ES', {day:'numeric', month:'short'})} - ${weekDates[6].toLocaleDateString('es-ES', {day:'numeric', month:'short', year:'numeric'})}`;
            const corner = document.createElement('div');
            corner.className = 'header-cell border-r bg-gray-50';
            const hTZ = Math.floor(currentTZ), mTZ = (currentTZ % 1) * 60;
            corner.innerHTML = `<button onclick="toggleTZModal()" class="tz-capsule">UTC${currentTZ >= 0 ? '+' : ''}${hTZ}${mTZ ? ':30' : ''}</button>`;
            gridElement.appendChild(corner);
            weekDates.forEach(date => {
                const isT = isToday(date);
                const header = document.createElement('div');
                header.className = `header-cell ${isT ? 'is-today' : ''}`;
                header.innerHTML = `<span>${dayNames[date.getDay() === 0 ? 6 : date.getDay() - 1].substring(0,3)}</span><b>${date.getDate()}</b>`;
                gridElement.appendChild(header);
            });
            for (let h = 0; h < 24; h++) {
                ['00', '30'].forEach(min => {
                    const time = `${h.toString().padStart(2, '0')}:${min}`;
                    const label = document.createElement('div');
                    label.className = `time-label ${min === '00' ? 'hour-mark' : ''}`;
                    label.innerHTML = min === '00' ? `<span class="time-text">${time}</span>` : '&nbsp;';
                    gridElement.appendChild(label);
                    weekDates.forEach(date => {
                        const iso = formatISODate(date);
                        const cellId = `c-${iso}-${time}`;
                        const cell = document.createElement('div');
                        cell.id = cellId;
                        cell.className = `cell ${min === '00' ? 'hour-mark' : ''} ${h < 7 || h >= 22 ? 'night-slot' : ''} ${isToday(date) ? 'is-today' : ''} ${selectedSlots.has(cellId) ? 'selected' : ''}`;
                        cell.onmousedown = () => startDrag(cell);
                        cell.onmouseenter = () => handleDrag(cell);
                        cell.ontouchstart = (e) => { e.preventDefault(); startDrag(cell); };
                        cell.ontouchmove = handleTouchMove;
                        gridElement.appendChild(cell);
                    });
                });
            }
            const noonLine = document.createElement('div');
            noonLine.className = 'noon-line-indicator';
            const [nh, nm] = noonTime.split(':').map(Number);
            const totalMinutes = nh * 60 + nm;
            setTimeout(() => {
                const rowElements = Array.from(gridElement.children);
                if (rowElements.length > 8) {
                    const slotIndex = Math.floor(totalMinutes / 30);
                    const offsetInSlot = (totalMinutes % 30) / 30;
                    const targetLabel = rowElements[8 + (slotIndex * 8)]; 
                    if (targetLabel) {
                        const rect = targetLabel.getBoundingClientRect();
                        const containerRect = gridElement.getBoundingClientRect();
                        noonLine.style.top = `${rect.top - containerRect.top + (rect.height * offsetInSlot)}px`;
                        noonLine.style.gridColumn = "1 / 9";
                        gridElement.appendChild(noonLine);
                    }
                }
            }, 0);
        }

        function renderMonthView() {
            gridElement.className = 'month-wrapper';
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            periodLabel.innerText = currentDate.toLocaleDateString('es-ES', {month: 'long', year: 'numeric'});
            dayNames.forEach(name => {
                const h = document.createElement('div');
                h.className = 'header-cell'; h.innerHTML = `<span>${name.substring(0,3)}</span>`;
                gridElement.appendChild(h);
            });
            const firstDay = new Date(year, month, 1);
            const startOffset = (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1);
            const calStart = new Date(firstDay); calStart.setDate(firstDay.getDate() - startOffset);
            for (let i = 0; i < 42; i++) {
                const d = new Date(calStart); d.setDate(calStart.getDate() + i);
                const iso = formatISODate(d);
                const isCurrMonth = d.getMonth() === month;
                const dayEl = document.createElement('div');
                dayEl.className = `month-day ${!isCurrMonth ? 'other-month' : ''} ${isToday(d) ? 'is-today' : ''}`;
                dayEl.innerHTML = `<div class="day-num-wrapper"><span class="day-num">${d.getDate()}</span></div>`;
                const miniSchedule = document.createElement('div');
                miniSchedule.className = 'mini-schedule-container';
                for (let h = 0; h < 24; h++) {
                    ['00', '30'].forEach(m => {
                        const time = `${h.toString().padStart(2, '0')}:${m}`;
                        const slot = document.createElement('div');
                        slot.className = `mini-slot ${selectedSlots.has(`c-${iso}-${time}`) ? 'active' : 'inactive'} ${h < 7 || h >= 22 ? 'night-slot' : ''}`;
                        miniSchedule.appendChild(slot);
                    });
                }
                const [nh, nm] = noonTime.split(':').map(Number);
                const miniNoon = document.createElement('div');
                miniNoon.className = 'mini-noon-line';
                miniNoon.style.top = `${((nh * 60 + nm) / 1440) * 100}%`;
                miniSchedule.appendChild(miniNoon);
                dayEl.appendChild(miniSchedule); gridElement.appendChild(dayEl);
            }
        }

        // --- EXPORTAR PDF REPARADO ---
        async function exportToPDF() {
            if (selectedSlots.size === 0) {
                showToast("Sin disponibilidad seleccionada");
                return;
            }

            const pdfArea = document.getElementById('pdf-render-area');
            pdfArea.innerHTML = '';
            showToast("Generando PDF...");

            const monthsWithData = new Set();
            const weeksWithData = new Set();

            selectedSlots.forEach(id => {
                const parts = id.split('-'); 
                monthsWithData.add(`${parts[1]}-${parts[2]}`);
                const d = new Date(parts[1], parts[2] - 1, parts[3]);
                weeksWithData.add(formatISODate(getMonday(d)));
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const sortedMonths = Array.from(monthsWithData).sort();
            const sortedWeeks = Array.from(weeksWithData).sort();

            const hTZ = Math.floor(currentTZ), mTZ = (currentTZ % 1) * 60;
            const tzString = `UTC${currentTZ >= 0 ? '+' : ''}${hTZ}${mTZ ? ':30' : ''}`;

            // 1. P√°ginas de Meses
            for (let i = 0; i < sortedMonths.length; i++) {
                const mKey = sortedMonths[i];
                const [y, m] = mKey.split('-').map(Number);
                const page = document.createElement('div');
                page.className = 'pdf-page-wrapper';
                const dLabel = new Date(y, m - 1, 1).toLocaleDateString('es-ES', {month: 'long', year: 'numeric'}).toUpperCase();
                
                page.innerHTML = `
                    <div class="pdf-header-box">
                        <div class="pdf-main-title">RendezPlan - Mes</div>
                        <div class="pdf-period-tag">${dLabel}</div>
                    </div>
                    <div id="pdf-grid-container" style="display:flex; flex-wrap:wrap; width:100%; gap:10px; background:#fff; padding-top:10px;">
                        ${dayNames.map(n => `<div style="width:calc(14.28% - 10px); text-align:center; font-weight:800; font-size:10px; border-bottom:2px solid #333; padding-bottom:5px; font-family:Arial;">${n.substring(0,3)}</div>`).join('')}
                    </div>
                `;

                const grid = page.querySelector('#pdf-grid-container');
                const firstDay = new Date(y, m - 1, 1);
                const startOffset = (firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1);
                const calStart = new Date(firstDay); calStart.setDate(firstDay.getDate() - startOffset);

                for (let j = 0; j < 42; j++) {
                    const d = new Date(calStart); d.setDate(calStart.getDate() + j);
                    const iso = formatISODate(d);
                    const dayBox = document.createElement('div');
                    dayBox.style.cssText = `width:calc(14.28% - 10px); height:125px; border:1px solid #eee; border-radius:12px; position:relative; overflow:hidden; opacity:${d.getMonth() === m - 1 ? 1 : 0.2}; background:#fff;`;
                    
                    dayBox.innerHTML = `
                        <div style="position:absolute; top:6px; left:6px; width:22px; height:22px; z-index:10;">
                            <svg width="22" height="22">
                                <circle cx="11" cy="11" r="10.5" fill="white" stroke="#ddd" stroke-width="1" />
                                <text x="11" y="11" font-family="Arial" font-size="10" font-weight="700" fill="#111" text-anchor="middle" dominant-baseline="central">${d.getDate()}</text>
                            </svg>
                        </div>
                    `;
                    
                    const mini = document.createElement('div');
                    mini.style.cssText = "display:flex; flex-direction:column; position:absolute; inset:0; z-index:1;";
                    for (let h = 0; h < 24; h++) {
                        ['00', '30'].forEach(min => {
                            const time = `${h.toString().padStart(2, '0')}:${min}`;
                            const active = selectedSlots.has(`c-${iso}-${time}`);
                            const night = h < 7 || h >= 22;
                            const slot = document.createElement('div');
                            slot.style.cssText = `flex:1; width:100%; background-color:${active ? (night ? '#14532d' : '#16a34a') : (night ? '#e2e8f0' : 'transparent')};`;
                            mini.appendChild(slot);
                        });
                    }
                    const [nh, nm] = noonTime.split(':').map(Number);
                    const miniNoon = document.createElement('div');
                    miniNoon.style.cssText = `position:absolute; left:0; right:0; height:1.5px; background-color:#fbbf24; z-index:4; top:${((nh * 60 + nm) / 1440) * 100}%;`;
                    mini.appendChild(miniNoon);
                    dayBox.appendChild(mini);
                    grid.appendChild(dayBox);
                }
                
                pdfArea.appendChild(page);
                const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false });
                if (i > 0) doc.addPage();
                doc.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 210, 297);
                pdfArea.innerHTML = '';
            }

            // 2. P√°ginas de Semanas
            for (let i = 0; i < sortedWeeks.length; i++) {
                const monStr = sortedWeeks[i];
                const monDate = new Date(monStr + 'T12:00:00');
                const sunDate = new Date(monDate); sunDate.setDate(monDate.getDate() + 6);
                
                const page = document.createElement('div');
                page.className = 'pdf-page-wrapper';
                page.innerHTML = `
                    <div class="pdf-header-box">
                        <div class="pdf-main-title">RendezPlan - Semana</div>
                        <div class="pdf-period-tag">${monDate.toLocaleDateString('es-ES', {day:'numeric', month:'short'})} - ${sunDate.toLocaleDateString('es-ES', {day:'numeric', month:'short', year:'numeric'})}</div>
                    </div>
                `;

                // A√±adimos padding-top a la rejilla para que el 00:00 no se corte
                const weekGrid = document.createElement('div');
                weekGrid.style.cssText = "display:grid; grid-template-columns:45px repeat(7,1fr); grid-template-rows:40px repeat(48,1fr); flex:1; border:1px solid #eee; border-radius:15px; overflow:hidden; font-size:8px; background:#fff; position:relative; margin-top:5px;";
                
                // Corner
                const corner = document.createElement('div');
                corner.style.cssText = "display:flex; align-items:center; justify-content:center; background:#f1f5f9; border-bottom:1px solid #ccc; border-right:1px solid #ddd; font-size:9px; font-weight:900; color:#1e293b; font-family:Arial;";
                corner.innerHTML = `<span style="background:#fff; border:1px solid #e2e8f0; padding:2px 4px; border-radius:10px; font-size:8px;">${tzString}</span>`;
                weekGrid.appendChild(corner);

                for(let d=0; d<7; d++){
                    const dh = document.createElement('div');
                    const target = new Date(monDate); target.setDate(monDate.getDate() + d);
                    dh.style.cssText = "text-align:center; font-weight:bold; border-bottom:1px solid #ddd; background:#f8fafc; font-family:Arial; height:40px; display:flex; flex-direction:column; justify-content:center;";
                    dh.innerHTML = `<span style="font-size:9px; color:#64748b; line-height:14px;">${dayNames[d].substring(0,3)}</span><span style="font-size:12px; color:#1e293b; line-height:16px;">${target.getDate()}</span>`;
                    weekGrid.appendChild(dh);
                }

                // C√°lculo manual en P√≠xeles para la l√≠nea de mediod√≠a del PDF
                const [nh, nm] = noonTime.split(':').map(Number);
                const totalMinutesInDay = 1440;
                const totalMinutesNoon = nh * 60 + nm;
                const gridContentHeight = 100; // Porcentaje del grid ocupado por filas de horas
                const noonLinePDF = document.createElement('div');
                // Posici√≥n relativa: 40px es el header, luego viene el 100% de las 48 filas
                noonLinePDF.style.cssText = `position:absolute; left:45px; right:0; height:2px; background-color:#fbbf24; z-index:40; top:calc(40px + (100% - 40px) * (${totalMinutesNoon / totalMinutesInDay})); pointer-events:none; border-bottom:1px solid rgba(0,0,0,0.1);`;
                weekGrid.appendChild(noonLinePDF);

                for (let h = 0; h < 24; h++) {
                    ['00', '30'].forEach(min => {
                        const time = `${h.toString().padStart(2, '0')}:${min}`;
                        const label = document.createElement('div');
                        label.style.cssText = "position:relative; border-right:1px solid #eee; border-bottom:1px solid #fdfdfd; background:#fff; height:100%; overflow:visible;";
                        
                        if(min === '00') {
                            // Ajuste: bajamos 4px el centro para que flote sobre la l√≠nea sin recortarse arriba
                            label.innerHTML = `
                                <div style="position:absolute; width:45px; top:0; right:0; height:0; overflow:visible; z-index:50;">
                                    <div style="margin-top:-6px; text-align:right; padding-right:5px; background:white; display:inline-block; float:right;">
                                        <span style="font-size:9px; font-weight:700; color:#1e293b; font-family:Arial; line-height:12px;">${time}</span>
                                    </div>
                                </div>`;
                        }
                        weekGrid.appendChild(label);

                        for(let d=0; d<7; d++){
                            const target = new Date(monDate); target.setDate(monDate.getDate() + d);
                            const iso = formatISODate(target);
                            const cell = document.createElement('div');
                            const active = selectedSlots.has(`c-${iso}-${time}`);
                            const night = h < 7 || h >= 22;
                            cell.style.cssText = `border-right:1px solid #f1f5f9; border-bottom:1px solid #f1f5f9; background-color:${active ? (night ? '#14532d' : '#16a34a') : (night ? '#e2e8f0' : '#fff')};`;
                            weekGrid.appendChild(cell);
                        }
                    });
                }
                
                page.appendChild(weekGrid);
                pdfArea.appendChild(page);
                const canvas = await html2canvas(page, { scale: 2, useCORS: true, logging: false, windowWidth: 1000 });
                doc.addPage();
                doc.addImage(canvas.toDataURL('image/jpeg', 0.95), 'JPEG', 0, 0, 210, 297);
                pdfArea.innerHTML = '';
            }

            doc.save('Disponibilidad_RendezPlan.pdf');
            showToast("PDF generado con √©xito");
        }

        function copyWeekToClipboard() {
            const monday = getMonday(currentDate);
            const pattern = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday); d.setDate(monday.getDate() + i);
                const iso = formatISODate(d);
                for (let h = 0; h < 24; h++) {
                    ['00', '30'].forEach(m => {
                        const t = `${h.toString().padStart(2, '0')}:${m}`;
                        if (selectedSlots.has(`c-${iso}-${t}`)) pattern.push({ dayOffset: i, time: t });
                    });
                }
            }
            weekPatternClipboard = pattern;
            pasteBtn.disabled = false; pasteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            copyAvailabilityToText(); showToast("Semana copiada");
        }

        function pasteFromClipboard() {
            if (!weekPatternClipboard) return;
            const monday = getMonday(currentDate);
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday); d.setDate(monday.getDate() + i);
                const iso = formatISODate(d);
                Array.from(selectedSlots).forEach(id => { if (id.includes(iso)) selectedSlots.delete(id); });
            }
            weekPatternClipboard.forEach(item => {
                const target = new Date(monday); target.setDate(monday.getDate() + item.dayOffset);
                selectedSlots.add(`c-${formatISODate(target)}-${item.time}`);
            });
            render(); showToast("Horario pegado");
        }

        function startDrag(el) { isMouseDown = true; isSelecting = !el.classList.contains('selected'); toggleCell(el); }
        function handleDrag(el) { if (isMouseDown) toggleCell(el); }
        function handleTouchMove(e) {
            if (!isMouseDown) return;
            const t = e.touches[0]; const el = document.elementFromPoint(t.clientX, t.clientY);
            if (el && el.classList.contains('cell')) toggleCell(el);
        }
        function toggleCell(el) {
            if (isSelecting) { el.classList.add('selected'); selectedSlots.add(el.id); }
            else { el.classList.remove('selected'); selectedSlots.delete(el.id); }
        }
        window.onmouseup = () => isMouseDown = false;
        window.ontouchend = () => isMouseDown = false;

        function changePeriod(dir) {
            if (viewMode === 'week') currentDate.setDate(currentDate.getDate() + (dir * 7));
            else currentDate.setMonth(currentDate.getMonth() + dir);
            render();
        }
        function setView(mode) {
            viewMode = mode;
            document.getElementById('view-week-btn').classList.toggle('active', mode === 'week');
            document.getElementById('view-month-btn').classList.toggle('active', mode === 'month');
            render();
        }
        function showToast(msg) {
            const t = document.getElementById('toast'); document.getElementById('toast-text').innerText = msg;
            t.classList.add('visible'); setTimeout(() => t.classList.remove('visible'), 2500);
        }
        function copyAvailabilityToText() {
            const monday = getMonday(currentDate);
            let text = `üóìÔ∏è *Mi disponibilidad (${monday.toLocaleDateString('es-ES', {day:'numeric', month:'short'})} - ...):*\n\n`;
            let has = false;
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday); d.setDate(monday.getDate() + i);
                const iso = formatISODate(d);
                let ivals = [], start = null, last = null;
                for (let h = 0; h < 24; h++) {
                    ['00', '30'].forEach(m => {
                        const t = `${h.toString().padStart(2, '0')}:${m}`;
                        if (selectedSlots.has(`c-${iso}-${t}`)) { if (start === null) start = t; last = t; }
                        else if (start !== null) { ivals.push(`${start} - ${add30(last)}`); start = null; }
                    });
                }
                if (start !== null) ivals.push(`${start} - ${add30(last)}`);
                if (ivals.length > 0) { has = true; text += `*${dayNames[i]} ${d.getDate()}:* ${ivals.join(', ')}\n`; }
            }
            if (has) { const d = document.createElement("textarea"); document.body.appendChild(d); d.value = text; d.select(); document.execCommand("copy"); document.body.removeChild(d); }
        }
        function add30(t) { let [h, m] = t.split(':').map(Number); m += 30; if (m === 60) { h++; m = 0; } if (h === 24) return "00:00"; return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`; }

        render();
    </script>
</body>
</html>